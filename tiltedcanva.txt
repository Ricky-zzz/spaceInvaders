import Explosion from "./Explosion.js";

export default class Player {
    shootPressed = false;
    rightPressed = false;
    leftPressed = false;

    constructor(canvas, velocity, bulletController, onTiltChange) {
        this.canvas = canvas;
        this.velocity = velocity;
        this.bulletController = bulletController;
        this.onTiltChange = onTiltChange;
        this.width = 50;
        this.height = 58;
        this.x = (this.canvas.width - this.width) / 2;
        this.y = this.canvas.height - this.height - 30;
        this.lives = 3;
        this.boostCount = 1;

        this.isBoostActive = false;
        this.boostTimer = 0;
        this.normalVelocity = velocity;
        this.boostDuration = 600;
        this.isImmune = false;
        this.isHit = false;
        this.flashTimer = 0;
        this.flashDuration = 60;

        this.image = new Image();
        this.image.src = 'images/ship2.png';

        this.explosion = null;
        this.explodeSound = new Audio("sounds/explode.mp3");
        this.explodeSound.volume = 0.4;
        this.powerUpSound = new Audio("sounds/power-up.mp3");
        this.powerUpSound.volume = 0.4;
        this.powerDownSound = new Audio("sounds/power-down.mp3");
        this.powerDownSound.volume = 0.4;

        document.addEventListener("keydown", this.keyDown);
        document.addEventListener("keyup", this.keyUp);
    }

    move() {
        if (this.rightPressed && this.x + this.width < this.canvas.width) {
            this.x += this.velocity;
            this.onTiltChange(0.05);
        } else if (this.leftPressed && this.x > 0) {
            this.x -= this.velocity;
            this.onTiltChange(-0.05);
        } else {
            this.onTiltChange(0);
        }
    }

    draw(ctx) {
        if (this.explosion) {
            this.explosion.draw(ctx);
            if (this.explosion.done) {
                this.explosion = null;
            }
        }
        if (this.shootPressed && this.bulletController.bulletInterval <= 0) {
            if (this.isBoostActive) {
                this.bulletController.shoot(this.x + this.width / 2 - 35, this.y + 5, -6);
                this.bulletController.shoot(this.x + this.width / 2 - 10, this.y + 5, -6);
                this.bulletController.shoot(this.x + this.width / 2 + 15, this.y + 5, -6);
                this.bulletController.bulletInterval = 5;
            } else {
                this.bulletController.shoot(this.x + this.width / 2 - 10, this.y, -4);
                this.bulletController.bulletInterval = 10;
            }
        }

        this.move();

        if (this.isHit && this.flashTimer > 0) {
            if (Math.floor(this.flashTimer / 5) % 2 === 0) {
                ctx.globalAlpha = 0.4;
            } else {
                ctx.globalAlpha = 1.0;
            }
            this.flashTimer--;
            if (this.flashTimer <= 0) {
                this.isHit = false;
                ctx.globalAlpha = 1.0;
            }
        } else {
            ctx.globalAlpha = 1.0;
        }


        if (this.isBoostActive) {
            ctx.shadowColor = 'yellow';
            ctx.shadowBlur = 25;
        } else {
            ctx.shadowBlur = 0;
        }
        ctx.save();
        ctx.translate(this.x + this.width / 2, this.y + this.height / 2); 
        let shipTilt = 0;
        if (this.rightPressed) shipTilt = 0.25;  
        else if (this.leftPressed) shipTilt = -0.25; 

        ctx.rotate(shipTilt);

        ctx.drawImage(
            this.image,
            -this.width / 2,
            -this.height / 2,
            this.width,
            this.height
        );

        ctx.restore();

        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1.0;


        if (this.isBoostActive) {
            this.boostTimer--;
            if (this.boostTimer <= 0) {
                this.deactivateBoost();
            }
        }
    }

    takeDamage() {
        if (this.isImmune) return;

        this.explodeSound.currentTime = 0;
        this.explodeSound.play();
        this.explosion = new Explosion(this.x, this.y);


        this.lives--;
        this.isHit = true;
        this.flashTimer = this.flashDuration;


        this.isImmune = true;
        setTimeout(() => (this.isImmune = false), 1500);
    }

    activateBoost() {
        this.powerUpSound.currentTime = 0;
        this.powerUpSound.play();
        this.isBoostActive = true;
        this.isImmune = true;
        this.boostTimer = this.boostDuration;
        this.velocity = this.normalVelocity * 2;
        this.bulletController.setMaxBullets(500);
    }

    deactivateBoost() {
        this.powerDownSound.currentTime = 0;
        this.powerDownSound.play();
        this.isBoostActive = false;
        this.isImmune = false;
        this.velocity = this.normalVelocity;
        this.bulletController.resetMaxBullets();
    }

    useBoost() {
        if (this.boostCount > 0 && !this.isBoostActive) {
            this.boostCount--;
            this.activateBoost();
        }
    }

    keyDown = (event) => {
        if (event.code === "ArrowRight") this.rightPressed = true;
        if (event.code === "ArrowLeft") this.leftPressed = true;
        if (event.code === "Space") this.shootPressed = true;
        if (event.code === "KeyB") this.useBoost();
    };

    keyUp = (event) => {
        if (event.code === "ArrowRight") this.rightPressed = false;
        if (event.code === "ArrowLeft") this.leftPressed = false;
        if (event.code === "Space") this.shootPressed = false;
    };
}
import EnemyController from "./EnemyController.js";
import Player from "./Player.js";
import BulletController from "./BulletController.js";
import BossController from "./BossController.js";
import PowerUpController from "./PowerUpController.js";
import SoundManager from "./sound.js";

// ======== SOUND MANAGER ========
const sound = new SoundManager();

// ======== BUTTON REFERENCES ========
const startBtn = document.getElementById("start-btn");
const mainMenuBtn = document.getElementById("main-menu-btn");
const nextRoundBtn = document.getElementById("next-round-btn");
const leaderboardBtn = document.getElementById("leaderboard-btn");


// ======== CANVAS SETUP ========
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 600;
canvas.height = 800;
let screenTilt = 0;
let targetTilt = 0;

// ======== BACKGROUND ========
const background = new Image();
background.src = "images/space.png";

// ======== GAME STATE VARS ========
let playerBulletController;
let enemyBulletController;
let enemyCtrl;
let bossCtrl;
let player;

let isBossRound = false;
let isGameOver = false;
let didWIn = false;
let gameRunning = false;
let gameLoop;

window.currentLevel = 1;
window.score = 0;

let enemyFireRate = 80;
let enemyRows = 4;

// ======== SCOREBOARD ========
function updateScoreboard() {
  const scoreDisplay = document.getElementById("score");
  const levelDisplay = document.getElementById("level");
  const livesDisplay = document.getElementById("lives");
  const boostDisplay = document.getElementById("boost");

  if (scoreDisplay) scoreDisplay.textContent = window.score;
  if (levelDisplay) levelDisplay.textContent = window.currentLevel;
  if (livesDisplay) livesDisplay.textContent = player?.lives ?? 3;
  if (boostDisplay) boostDisplay.textContent = player?.boostCount ?? 0;
}

// ======== GAME RESET FUNCTION ========
function resetGame(resetLevel = false) {
  if (gameLoop) {
    clearInterval(gameLoop);
    gameLoop = null;
  }

  if (resetLevel) {
    window.currentLevel = 1;
    window.score = 0;
    enemyFireRate = 40;
    enemyRows = 4;
  }

  isGameOver = false;
  didWIn = false;
  gameRunning = false;

  playerBulletController = new BulletController(canvas, 50, true, "images/bullet.png");
  enemyBulletController = new BulletController(canvas, 100, false, "images/enemybullet.png");

  // === Boss or Normal Round ===
  isBossRound = window.currentLevel % 3 === 0;
  if (isBossRound) {
    bossCtrl = new BossController(canvas, enemyBulletController, playerBulletController);
    enemyCtrl = null;
  } else {
    enemyCtrl = new EnemyController(canvas, enemyBulletController, playerBulletController, enemyFireRate, enemyRows);
    bossCtrl = null;
  }

  player = new Player(canvas, 5, playerBulletController, (tilt) => targetTilt = tilt);

  player.boostCount = 1;

  window.powerUpCtrl = new PowerUpController(canvas, player);
}

// ======== GAME LOOP ========
function startGameLoop() {
  if (gameRunning) return;
  gameRunning = true;
  gameLoop = setInterval(game, 1000 / 60);
}

function game() {
  checkGameOver();
  screenTilt += (targetTilt - screenTilt) * 0.1; 
  ctx.save();
  ctx.translate(canvas.width / 2, canvas.height / 2); 
  ctx.rotate(screenTilt); 
  ctx.translate(-canvas.width / 2, -canvas.height / 2); 

  ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
  ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
  displayGameOver();

  if (!isGameOver) {
    if (isBossRound) {
      bossCtrl?.draw(ctx);
    } else {
      enemyCtrl?.draw(ctx);
    }

    player.draw(ctx);
    playerBulletController.draw(ctx);
    enemyBulletController.draw(ctx);
    powerUpCtrl.draw(ctx);
    updateScoreboard();
  }
  ctx.restore();

}

// ======== GAME OVER DISPLAY ========
function displayGameOver() {
  if (!isGameOver) return;

  clearInterval(gameLoop);
  gameRunning = false;

  document.querySelector(".game-wrapper").classList.add("hidden");
  const resultScreen = document.getElementById("result-screen");
  const resultMsg = document.getElementById("result-message");
  resultScreen.classList.remove("hidden");

  sound.fadeOut(sound.combatMusic);
  sound.playMainMenuMusic();

  if (didWIn) {
    resultMsg.innerHTML = `LEVEL ${window.currentLevel} COMPLETE!<br>Score: ${window.score}`;
    nextRoundBtn.classList.remove("hidden");
  } else {
    resultMsg.innerHTML = `GAME OVER!<br>Final Score: ${window.score}<br>Reached Level: ${window.currentLevel}`;
    nextRoundBtn.classList.add("hidden");
  }

}

// ======== GAME OVER CHECK ========
function checkGameOver() {
  if (isGameOver) return;

  if (enemyBulletController.collideWith(player)) player.takeDamage();

  if (player.lives <= 0) {
    isGameOver = true;
    return;
  }

  if (isBossRound) {
    if (bossCtrl?.collideWith(player)) {
      isGameOver = true;
      return;
    }
    if (bossCtrl?.isDefeated()) {
      didWIn = true;
      isGameOver = true;
      window.score += 1000;
      return;
    }
  } else {
    if (enemyCtrl?.collideWith(player)) {
      isGameOver = true;
      return;
    }
    if (enemyCtrl?.enemyRows.length === 0) {
      didWIn = true;
      isGameOver = true;
      return;
    }
  }
}

// ======== BUTTON EVENTS ========

// START GAME
startBtn.addEventListener("click", () => {
  document.querySelector(".start-screen").classList.add("hidden");
  document.querySelector(".game-wrapper").classList.remove("hidden");
  document.querySelector(".game-wrapper").classList.add("fade-in");

  showRoundStart(() => {
    sound.playCombatMusic();
    resetGame(true);
    startGameLoop();
  });

});

// MAIN MENU
mainMenuBtn.addEventListener("click", () => {
  document.getElementById("result-screen").classList.add("hidden");
  document.querySelector(".start-screen").classList.remove("hidden");

  sound.playMainMenuMusic();

  resetGame(true);
});

nextRoundBtn.addEventListener("click", () => {
  document.getElementById("result-screen").classList.add("hidden");
  document.querySelector(".game-wrapper").classList.remove("hidden");

  sound.fadeOut(sound.mainMenuMusic);

  window.currentLevel++;
  enemyFireRate = Math.max(30, 80 - (window.currentLevel - 1) * 5);
  enemyRows = Math.min(8, 6 + Math.floor((window.currentLevel - 1) / 2));


  showRoundStart(() => {
    sound.playCombatMusic();
    resetGame();
    startGameLoop();
  });


});

// SHOW ROUND START EFFECT 
function showRoundStart(callback) {
  const overlay = document.getElementById("round-start");
  const warningSound = new Audio("sounds/warning.mp3");
  warningSound.volume = 0.8;

  overlay.classList.remove("hidden");
  warningSound.play();

  setTimeout(() => {
    overlay.classList.add("hidden");
    callback();
  }, 2000);
}

window.addEventListener("click", () => {
  sound.playMainMenuMusic();
}, { once: true });


